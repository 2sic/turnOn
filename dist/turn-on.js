(()=>{"use strict";var t="error",n="debug",r="reject",e="turnOn",o=function(){this.interval=100,this.attempts=100,this.log=t,this.failure=r,this.name=e},i="9-error",s=function(){return s=Object.assign||function(t){for(var n,r=1,e=arguments.length;r<e;r++)for(var o in n=arguments[r])Object.prototype.hasOwnProperty.call(n,o)&&(t[o]=n[o]);return t},s.apply(this,arguments)},a=function(){function r(){}return r.createError=function(t){return{await:[],debug:!1,run:"",progress:i,error:t,addContext:!1}},r.load=function(t){var n,e;try{n=JSON.parse(t)}catch(t){return r.createError("detected configuration but cannot parse to json.")}try{e=r.stabilize(n)}catch(t){return r.createError("Error loading configuration, reason unknown.")}return e},r.stabilize=function(e){var i,a,u;if(!e)return r.createError("No turn-on config found to process");if(!e.run)return r.createError("Config didn't contain 'run' - it's required.");if(!e.run.startsWith("window"))return r.createError("run command must start with 'window.' but is:"+e.run);if(!e.run.endsWith("()"))return r.createError("run must be a function name and end with () but it's:"+e.run);var c=null!==(i=e.require)&&void 0!==i?i:e.await,l=Array.isArray(c)?c:c?[c]:[];if(l.push(e.run.substring(0,e.run.length-2)),e.args&&!Array.isArray(e.args))return r.createError("args must be an array if given");var f=null!==(a=null==e?void 0:e.debug)&&void 0!==a&&a?n:t,d=null!=e.addContext?e.addContext:!e.args,h=e.data||e.args?void 0:{};return{await:l,debug:null!==(u=e.debug)&&void 0!==u&&u,run:e.run,progress:"1-loaded",data:h,args:e.args,settings:s(s(s({},new o),{log:f}),e.settings),addContext:d}},r}(),u="turn-on",c="turn-on-skip",l="window",f="turn-on: ";function d(t,n,r){window.debugTurnOn&&(r?console.log(f+t,n,r):n?console.log(f+t,n):console.log(f+t))}var h=function(){function t(t,n,r){this.tag=t,this.config=n,this.turnOn=r,this.syncDom()}return t.prototype.syncDom=function(){d("syncDom",this);var t=this.tag;t.getAttribute(c)||t.setAttribute(c,"skip");var n=JSON.stringify(this.config);t.getAttribute(u)!==n&&t.setAttribute(u,n)},t.prototype.progress=function(t){this.config.progress=t,this.syncDom()},t.prototype.error=function(t){throw this.config.progress=i,this.config.error=t,this.syncDom(),this.config.error},t}(),g=function(){function t(t,n,r,e,o,i,s){this.success=t,this.result=n,this.parent=r,this.lastName=e,this.parts=o,this.partsFound=i,this.matchedKey=s}return t.test=function(n){if(!n)return new t(!0,null,null,null,0,0,"");var r=n.split(".");if(r[0]!==l)throw"Key must start with '".concat(l,".' but it's '").concat(n,"'");if(1==r.length)return new t(!0,window,null,l,1,1,l);for(var e,o=window,i=null,s=l,a=1;a<r.length;a++)if(i=o,s+="."+(e=r[a]),!(o=o[e]))return new t(!1,null,i,e,r.length,a,s);return new t(!0,o,i,e,r.length,r.length,s)},t}(),p=function(){return p=Object.assign||function(t){for(var n,r=1,e=arguments.length;r<e;r++)for(var o in n=arguments[r])Object.prototype.hasOwnProperty.call(n,o)&&(t[o]=n[o]);return t},p.apply(this,arguments)},y=function(t,n,r){if(r||2===arguments.length)for(var e,o=0,i=n.length;o<i;o++)!e&&o in n||(e||(e=Array.prototype.slice.call(n,0,o)),e[o]=n[o]);return t.concat(e||Array.prototype.slice.call(n))};var v,w=function(){function t(t){this.root=t,this.tags=new Array}return t.prototype.tryToLoadTag=function(t){var n,r,e=null===(n=null==t?void 0:t.getAttribute)||void 0===n?void 0:n.call(t,u);if(e){var o=null===(r=null==t?void 0:t.getAttribute)||void 0===r?void 0:r.call(t,c);if(d("skip",o),o)return d("skip");d("attr",e);var s=a.load(e);s.progress!==i?(d("stable config"),this.add(t,s)):console.error(s.error,t,e)}},t.prototype.add=function(t,n){d("add",t,n);var r=new h(t,n);this.tags.push(r),function(t,n){var r=n.config;d("convert to turnon");var e=t.new(r.settings);r.settings=e.settings;var o=e.await(r.await);n.progress("2-watching"),o.then((function(){var t=r.run;if(d("turn on success - will try to run "+t),n.progress("3-running"),t.endsWith("()")){var e=g.test(t.substr(0,t.length-2));if(e.success)if("function"==typeof e.result){var o=r.data,i={tag:n.tag,config:r},s=e.parent;if(r.args){var a=function(t,n){var r=t.data,e=t.args;if(d("mergeArgsWithDataAndContext",{config:t,contextData:n,data:r,fnArgs:e}),null!=t.data){var o="data"!==t.addContext||null===r||"object"!=typeof r||Array.isArray(r)?r:p(p({},n),r);e=y([o],e,!0)}return"end"===t.addContext&&(e=y(y([],e,!0),[n],!1)),e}(r,i);s[e.lastName].apply(s,a)}else s[e.lastName](o,i);n.progress("4-completed")}else n.error("Got ".concat(e.partsFound," but it's not a function"));else n.error("Tried to find object parts for ".concat(e.matchedKey," but didn't get anything."))}else n.error("run should end with () but doesn't - can't continue")}))}(this.root,r)},t.prototype.updateTags=function(){d("updateTags: ".concat(this.tags.length)),this.tags.forEach((function(t){return t.syncDom()}))},t}(),m="[".concat(u,"]:not([").concat(c,"])"),b=function(){function t(t){this.tagManager=t,this.config={attributes:!1,childList:!0,subtree:!0},this.scanExistingDom(),this.activateObserver()}return t.prototype.scanExistingDom=function(){d("scanExistingDom"),document.documentElement&&this.checkAndLoadChildren(document.documentElement)},t.prototype.checkAndLoadChildren=function(t){var n,r=this;d("checkAndLoadChildren",t),(null===(n=null==t?void 0:t.children)||void 0===n?void 0:n.length)&&t.querySelectorAll(m).forEach((function(t){return r.tagManager.tryToLoadTag(t)}))},t.prototype.activateObserver=function(){var t=this;d("activateObserver"),this.observer=new MutationObserver((function(n){d("mutations detected",n),n.forEach((function(n){"childList"==n.type&&(d("childList changes"),Array.from(n.addedNodes).filter((function(t){return 1===t.nodeType})).forEach((function(n){var r;(null===(r=null==n?void 0:n.getAttribute)||void 0===r?void 0:r.call(n,u))?t.tagManager.tryToLoadTag(n):t.checkAndLoadChildren(n)})))}))})),this.observer.observe(document.documentElement,this.config)},t}(),O=function(t,n,r,e,o){void 0===e&&(e="not set"),this.type=t,this.ready=n,this.message=r,this.name=e,this.result=o,this.attempts=0},A=(v=function(t,n){return v=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,n){t.__proto__=n}||function(t,n){for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(t[r]=n[r])},v(t,n)},function(t,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function r(){this.constructor=t}v(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}),k=function(t){function n(n){var r=this;n||(n=[]);var e=function(t){return!!Array.isArray(t)&&t.filter((function(t){return t.ready})).length==t.length}(n),o=0===n.length?"no conditions provided":e?"all ok":"some conditions did not complete";return(r=t.call(this,"summary",e,o,"Summary")||this).details=n,r}return A(n,t),n}(O),E=function(){return E=Object.assign||function(t){for(var n,r=1,e=arguments.length;r<e;r++)for(var o in n=arguments[r])Object.prototype.hasOwnProperty.call(n,o)&&(t[o]=n[o]);return t},E.apply(this,arguments)},j="promise",C=function(){function t(t,n){this.lastStatus=new O(j,!1,"condition not checked yet"),this.attempts=0,this.innerCheck=t,this.settings=n}return t.prototype.innerCheck=function(){return new O(j,!0,"no condition defined")},t.prototype.check=function(){return!0===this.lastStatus.ready||(this.lastStatus=this.innerCheck()),this.lastStatus},t.prototype.asPromise=function(){var t=this,n=function(r,e){var o=t.check();!0!==o.ready?t.attempts++>=t.settings.attempts?r(E(E({},o),{message:"tried up to max attempts: "+o.message,attempts:t.attempts})):setTimeout(n,t.settings.interval,r,e):r(E(E({},o),{attempts:t.attempts}))};return new Promise(n)},t}();function T(t){var n=t.toString();return n&&n.length>25&&(n=n.substr(0,25)),function(){return new O("fn",t(),"",n)}}var x="window-key";function P(t){return t?t===l?function(){return new O(x,!0,"no keys except maybe windows found",t)}:function(){var n=g.test(t);return n.success?new O(x,!0,"all keys matched",t,n.result):new O(x,!1,"Not all keys matched yet. So far '".concat(n.matchedKey,"' worked."),t)}:function(){return new O(x,!0,"empty key",t)}}var S=function(){return S=Object.assign||function(t){for(var n,r=1,e=arguments.length;r<e;r++)for(var o in n=arguments[r])Object.prototype.hasOwnProperty.call(n,o)&&(t[o]=n[o]);return t},S.apply(this,arguments)},L="named fn",D=function(){function t(){}return t.prototype.make=function(t){return"function"==typeof t?T(t):"string"==typeof t?t.endsWith("()")?function(t){if(!t.endsWith("()"))throw"Tried to create Function-Name condition but that requires it to end with (), got ".concat(t);var n,r=P(t.substring(0,t.length-2));return function(){if(!n){var t=r();if(!t.ready)return S(S({},t),{type:L});if("function"!=typeof t.result)return S(S({},t),{type:L});n=T(t.result)}return S(S({},n()),{type:L})}}(t):P(t):void 0},t}(),_=function(){return _=Object.assign||function(t){for(var n,r=1,e=arguments.length;r<e;r++)for(var o in n=arguments[r])Object.prototype.hasOwnProperty.call(n,o)&&(t[o]=n[o]);return t},_.apply(this,arguments)},N=function(){function t(n){this._conditionMaker=new D,"string"==typeof n&&(n={name:n}),n&&(this.settings=_(_({},new o),n)),t.count++}return t.prototype.new=function(n){return new t(n)},t.prototype.await=function(t){return this.require(t)},t.prototype.require=function(e){var o=this,i=(Array.isArray(e)?e:[e]).map((function(t){if(Promise.resolve(t)===t)return n=t,new Promise((function(t,r){n.then((function(n){t(new O("bool-promise",!1!==n,"from promise"))})).catch((function(t){return r(t)}))}));var n,r=o._conditionMaker.make(t);return new C(r,o.settings).asPromise()})),s=this,a=t.count;return new Promise((function(t,e){Promise.all(i).then((function(o){var i=new k(o);if((window.debugTurnOn||s.settings.log===n||!i.ready&&"silent"!==s.settings.log)&&s.logStatusList(i.ready,a,s.settings,o),!0!==i.ready)switch(s.settings.failure){case r:e(i);break;case"resolve":t(i);break;case"silent":return}else t(new k(o))}))}))},t.prototype.logStatusList=function(t,n,r,o){console.log(f+"#".concat(n," ")+(r.name!==e?'"'.concat(r.name,'" '):"")+(t?"success!":"couldn't complete because some conditions were not met. See details: "),o)},t.count=0,t}(),M=function(){function t(){this.tagManager=new w(this),this.loader=new b(this.tagManager),console.log("turnOn v0.3.0 active - it will help boot scripts when ready - set window.debugTurnOn = true for debugging")}return t.prototype.new=function(t){return new N(t)},t}();window.turnOn||(window.turnOn=new M)})();
//# sourceMappingURL=turn-on.js.map